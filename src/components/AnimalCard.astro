---
import type { ASMAnimal } from '../types/asm';
import { createAnimalSlug, createAnimalProfile, getCompatibilityIcon } from '../types/asm';

interface Props {
  animal: ASMAnimal;
  showBadges?: boolean;
  lazyLoad?: boolean;
}

const { animal, showBadges = true, lazyLoad = true } = Astro.props;

// Create SEO-friendly URL
const slug = createAnimalSlug(animal);
const speciesPath = animal.SPECIESNAME.toLowerCase();
const detailUrl = `/adopt/${speciesPath}/${animal.ID}/${slug}`;

// Create structured profile
const profile = createAnimalProfile(animal);

// Determine thumbnail URL
const thumbnailUrl = `https://service.sheltermanager.com/asmservice?account=st3418&method=animal_thumbnail&animalid=${animal.ID}`;

// Calculate days on shelter for display
const daysText = animal.DAYSONSHELTER === 1 ? '1 day' : `${animal.DAYSONSHELTER} days`;

// Get compatibility badges
const compatibilityBadges = [
  { condition: animal.ISGOODWITHCATS === 1, label: 'üê± Cat Friendly', color: 'bg-amber-100 text-amber-800' },
  { condition: animal.ISGOODWITHDOGS === 1, label: 'üêï Dog Friendly', color: 'bg-blue-100 text-blue-800' },
  { condition: animal.ISGOODWITHCHILDREN === 1, label: 'üë∂ Kid Friendly', color: 'bg-green-100 text-green-800' },
  { condition: animal.ISGOODWITHSMALLANIMALS === 1, label: 'üê∞ Small Animal Friendly', color: 'bg-pink-100 text-pink-800' },
  { condition: animal.ISHOUSETRAINED === 1, label: 'üè† House Trained', color: 'bg-indigo-100 text-indigo-800' },
  // Note: elderly, crate, travel, lead fields may not be available in ASM data
  // These filters will be hidden until proper ASM fields are identified
].filter(badge => badge.condition);

// Get status badges
const statusBadges = [
  { condition: animal.NEUTERED === 1, label: '‚úÖ Desexed', color: 'bg-indigo-200 text-indigo-800' },
  { condition: animal.IDENTICHIPPED === 1 || animal.MICROCHIPPED === 1, label: 'üîç Microchipped', color: 'bg-gray-100 text-gray-800' },
  { condition: animal.HASSPECIALNEEDS === 1, label: 'üíñ Special Needs', color: 'bg-red-100 text-red-800' },
  { condition: profile.medical.vaccinationCount && profile.medical.vaccinationCount > 0, label: `üíâ ${profile.medical.vaccinationCount}x Vacc`, color: 'bg-teal-100 text-teal-800' },
].filter(badge => badge.condition);
---

<article class="asm3-adoptable-item group">
  <a href={detailUrl} class="asm3-adoptable-link block h-full">
    <!-- Reserved Badge -->
    {animal.HASACTIVERESERVE === 1 && (
      <div class="asm3-adoptable-reserved absolute top-3 right-3 z-10">
        <span class="bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider shadow-lg transform rotate-12">
          Reserved
        </span>
      </div>
    )}

    <!-- Animal Photo -->
    <div class="relative overflow-hidden rounded-t-xl">
      <img 
        src={thumbnailUrl}
        alt={`${animal.ANIMALNAME} - ${animal.BREEDNAME} ${animal.SPECIESNAME}`}
        class="asm3-adoptable-thumbnail w-full h-72 object-cover transition-transform duration-500 group-hover:scale-105"
        loading={lazyLoad ? "lazy" : "eager"}
        decoding="async"
      />
      <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
    </div>

    <!-- Card Content -->
    <div class="p-6">
      <!-- Animal Name -->
      <h3 class="asm3-adoptable-name text-2xl font-bold text-gray-900 mb-3 group-hover:text-indigo-700 transition-colors duration-200">
        {animal.ANIMALNAME}
      </h3>

      <!-- Basic Info -->
      <div class="asm3-adoptable-tagline space-y-2 mb-4">
        <div class="flex items-center text-gray-600">
          <span class="text-sm font-medium">{animal.BREEDNAME}</span>
          {animal.CROSSBREED === 1 && (
            <span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Mix</span>
          )}
        </div>
        
        <div class="flex items-center gap-4 text-sm text-gray-500">
          <span class="inline-flex items-center px-2 py-1 bg-gray-50 rounded-md text-xs font-medium text-gray-700">
            {animal.AGEGROUP}
          </span>
          <span class="inline-flex items-center px-2 py-1 bg-gray-50 rounded-md text-xs font-medium text-gray-700">
            {animal.SEXNAME}
          </span>
          <span class="inline-flex items-center px-2 py-1 bg-gray-50 rounded-md text-xs font-medium text-gray-700">
            {animal.SIZENAME}
          </span>
        </div>
      </div>

      <!-- Enhanced Badges -->
      {showBadges && (compatibilityBadges.length > 0 || statusBadges.length > 0) && (
        <div class="space-y-2 mb-4">
          <!-- Compatibility Badges -->
          {compatibilityBadges.length > 0 && (
            <div class="flex flex-wrap gap-1.5">
              {compatibilityBadges.map(badge => (
                <span class={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${badge.color}`}>
                  {badge.label}
                </span>
              ))}
            </div>
          )}
          
          <!-- Status Badges -->
          {statusBadges.length > 0 && (
            <div class="flex flex-wrap gap-1.5">
              {statusBadges.map(badge => (
                <span class={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${badge.color}`}>
                  {badge.label}
                </span>
              ))}
            </div>
          )}
        </div>
      )}


      <!-- Location -->
      {profile.adoption.location && (
        <div class="mb-3 text-sm text-gray-600 flex items-center">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          üìç {profile.adoption.location}
        </div>
      )}

      <!-- View Details Button -->
      <div class="mt-4 text-center">
        <span class="text-indigo-700 hover:text-indigo-800 font-medium text-sm transition-colors duration-200">
          View Details ‚Üí
        </span>
      </div>
    </div>
  </a>
</article>

<style>
  .asm3-adoptable-item {
    background-color: white;
    border: 1px solid rgb(229 231 235);
    border-radius: 0.75rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.06);
    transition: all 0.3s ease-out;
    position: relative;
    overflow: hidden;
    border: 2px solid transparent;
  }
  
  .asm3-adoptable-item:hover {
    transform: translateY(-0.25rem);
    border-color: rgb(99 102 241);
    box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25), 0 0 0 1px rgb(99 102 241 / 0.1);
  }

  .asm3-adoptable-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 0.25rem;
    background: linear-gradient(90deg, rgb(99 102 241), rgb(59 130 246), rgb(139 92 246));
    opacity: 0;
    transition: opacity 0.3s ease-out;
  }

  .asm3-adoptable-item:hover::before {
    opacity: 1;
  }
</style>