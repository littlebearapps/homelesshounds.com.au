---
import type { AnimalFilters as FilterTypes } from '../types/asm';

interface Props {
  currentFilters?: {
    species?: string;
    agegroup?: string;
    size?: string;
    sex?: string;
    goodWith?: string;
    hasSpecialNeeds?: string;
    isHouseTrained?: string;
    hasActiveReserve?: string;
  };
  showSpeciesFilter?: boolean;
}

const { currentFilters = {}, showSpeciesFilter = true } = Astro.props;
---

<div class="bg-white rounded-xl border border-gray-200 p-6 mb-8">
  <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
    <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z" />
    </svg>
    Filter Animals
  </h2>
  
  <form id="animal-filters" class="space-y-6">
    <!-- Primary Filters Row -->
    <div class="flex flex-wrap gap-4">
      {showSpeciesFilter && (
        <div class="flex-1 min-w-32">
          <label for="species-filter" class="sr-only">Species</label>
          <select 
            id="species-filter" 
            name="species"
            class="filter-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          >
            <option value="">All Animals</option>
            <option value="dog" selected={currentFilters.species === 'dog'}>ğŸ• Dogs</option>
            <option value="cat" selected={currentFilters.species === 'cat'}>ğŸ± Cats</option>
          </select>
        </div>
      )}
      
      <div class="flex-1 min-w-32">
        <label for="agegroup-filter" class="sr-only">Age Group</label>
        <select 
          id="agegroup-filter" 
          name="agegroup"
          class="filter-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        >
          <option value="">Any Age</option>
          <option value="Young" selected={currentFilters.agegroup === 'Young'}>Young</option>
          <option value="Adult" selected={currentFilters.agegroup === 'Adult'}>Adult</option>
          <option value="Senior" selected={currentFilters.agegroup === 'Senior'}>Senior</option>
        </select>
      </div>
      
      <div class="flex-1 min-w-32">
        <label for="size-filter" class="sr-only">Size</label>
        <select 
          id="size-filter" 
          name="size"
          class="filter-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        >
          <option value="">Any Size</option>
          <option value="Small" selected={currentFilters.size === 'Small'}>Small</option>
          <option value="Medium" selected={currentFilters.size === 'Medium'}>Medium</option>
          <option value="Large" selected={currentFilters.size === 'Large'}>Large</option>
          <option value="Very Large" selected={currentFilters.size === 'Very Large'}>Very Large</option>
        </select>
      </div>
      
      <div class="flex-1 min-w-32">
        <label for="sex-filter" class="sr-only">Sex</label>
        <select 
          id="sex-filter" 
          name="sex"
          class="filter-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        >
          <option value="">Any Sex</option>
          <option value="Male" selected={currentFilters.sex === 'Male'}>Male</option>
          <option value="Female" selected={currentFilters.sex === 'Female'}>Female</option>
        </select>
      </div>
    </div>

    <!-- Enhanced Compatibility Filters -->
    <div>
      <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
        <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
        </svg>
        Compatibility & Special Requirements
      </h3>
      <div class="flex flex-wrap gap-4">
        <div class="flex-1 min-w-40">
          <label for="goodwith-filter" class="sr-only">Good With</label>
          <select 
            id="goodwith-filter" 
            name="goodWith"
            class="filter-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          >
            <option value="">Good With Any</option>
            <option value="cats" selected={currentFilters.goodWith === 'cats'}>ğŸ± Good with Cats</option>
            <option value="dogs" selected={currentFilters.goodWith === 'dogs'}>ğŸ• Good with Dogs</option>
            <option value="children" selected={currentFilters.goodWith === 'children'}>ğŸ‘¶ Good with Children</option>
            <option value="smallanimals" selected={currentFilters.goodWith === 'smallanimals'}>ğŸ° Good with Small Animals</option>
          </select>
        </div>

        <div class="flex-1 min-w-32">
          <label for="housetrained-filter" class="sr-only">House Trained</label>
          <select 
            id="housetrained-filter" 
            name="isHouseTrained"
            class="filter-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          >
            <option value="">Any Training</option>
            <option value="yes" selected={currentFilters.isHouseTrained === 'yes'}>ğŸ  House Trained</option>
            <option value="no" selected={currentFilters.isHouseTrained === 'no'}>Training Needed</option>
          </select>
        </div>

        <div class="flex-1 min-w-32">
          <label for="specialneeds-filter" class="sr-only">Special Needs</label>
          <select 
            id="specialneeds-filter" 
            name="hasSpecialNeeds"
            class="filter-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          >
            <option value="">Any Needs</option>
            <option value="yes" selected={currentFilters.hasSpecialNeeds === 'yes'}>ğŸ’– Special Needs</option>
            <option value="no" selected={currentFilters.hasSpecialNeeds === 'no'}>No Special Needs</option>
          </select>
        </div>

        <div class="flex-1 min-w-32">
          <label for="reserved-filter" class="sr-only">Availability</label>
          <select 
            id="reserved-filter" 
            name="hasActiveReserve"
            class="filter-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          >
            <option value="">All Animals</option>
            <option value="no" selected={currentFilters.hasActiveReserve === 'no'}>âœ… Available Now</option>
            <option value="yes" selected={currentFilters.hasActiveReserve === 'yes'}>ğŸ“‹ Reserved</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Sort and Actions Row -->
    <div class="flex flex-wrap gap-4 items-center justify-between pt-4 border-t border-gray-200">
      <div class="flex gap-4">
        <div class="min-w-48">
          <label for="sort-filter" class="sr-only">Sort By</label>
          <select 
            id="sort-filter" 
            name="sort"
            class="filter-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          >
            <option value="name">ğŸ“ Name A-Z</option>
            <option value="-name">ğŸ“ Name Z-A</option>
            <option value="age">ğŸ‘¶ Youngest First</option>
            <option value="-age">ğŸ§“ Oldest First</option>
            <option value="-daysonshelter">â° Longest in Care</option>
            <option value="daysonshelter">âœ¨ Newest Arrivals</option>
          </select>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3">
        <button 
          type="button" 
          id="clear-filters"
          class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors duration-200 flex items-center bg-gray-50 hover:bg-gray-100 rounded-lg"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Clear All
        </button>

        <button 
          type="button" 
          id="toggle-advanced"
          class="px-4 py-2 text-purple-600 hover:text-purple-800 font-medium transition-colors duration-200 flex items-center"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
          </svg>
          <span id="advanced-toggle-text">Simple View</span>
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  // Client-side filtering functionality
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('animal-filters');
    const clearButton = document.getElementById('clear-filters');
    
    if (!form || !clearButton) return;
    
    // Filter change handler
    function handleFilterChange() {
      const formData = new FormData(form);
      const params = new URLSearchParams();
      
      // Build query parameters
      for (const [key, value] of formData.entries()) {
        if (value && value !== '') {
          params.set(key, value);
        }
      }
      
      // Update URL without page reload
      const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      window.history.replaceState({}, '', newUrl);
      
      // Apply filters to visible animals
      filterAnimals(Object.fromEntries(params));
    }
    
    // Clear filters handler
    function clearFilters() {
      form.reset();
      window.history.replaceState({}, '', window.location.pathname);
      filterAnimals({});
    }
    
    // Apply filters to animal cards
    function filterAnimals(filters) {
      const animals = document.querySelectorAll('.asm3-adoptable-item');
      let visibleCount = 0;
      
      animals.forEach(animal => {
        let shouldShow = true;
        const link = animal.querySelector('a');
        const href = link?.getAttribute('href') || '';
        
        // Extract animal info from the card
        const nameEl = animal.querySelector('.asm3-adoptable-name');
        const taglineEl = animal.querySelector('.asm3-adoptable-tagline');
        const badgesEl = animal.querySelector('.flex.flex-wrap.gap-2');
        
        if (!nameEl || !taglineEl) return;
        
        const name = nameEl.textContent?.toLowerCase() || '';
        const content = taglineEl.textContent?.toLowerCase() || '';
        const badges = badgesEl?.textContent?.toLowerCase() || '';
        
        // Apply filters
        if (filters.species && !href.includes(`/adopt/${filters.species}/`)) {
          shouldShow = false;
        }
        
        if (filters.agegroup && !content.includes(filters.agegroup.toLowerCase())) {
          shouldShow = false;
        }
        
        if (filters.size && !content.includes(filters.size.toLowerCase())) {
          shouldShow = false;
        }
        
        if (filters.sex && !content.includes(filters.sex.toLowerCase())) {
          shouldShow = false;
        }
        
        if (filters.goodWith) {
          const goodWithMap = {
            'cats': 'cat friendly',
            'dogs': 'dog friendly', 
            'children': 'kid friendly',
            'smallanimals': 'small animal friendly'
          };
          const searchTerm = goodWithMap[filters.goodWith];
          if (searchTerm && !badges.includes(searchTerm)) {
            shouldShow = false;
          }
        }

        // Enhanced filtering for new fields
        if (filters.isHouseTrained === 'yes' && !badges.includes('house trained')) {
          shouldShow = false;
        }
        if (filters.isHouseTrained === 'no' && badges.includes('house trained')) {
          shouldShow = false;
        }
        
        if (filters.hasSpecialNeeds === 'yes' && !badges.includes('special needs')) {
          shouldShow = false;
        }
        if (filters.hasSpecialNeeds === 'no' && badges.includes('special needs')) {
          shouldShow = false;
        }

        // Availability filter
        const isReserved = animal.querySelector('.asm3-adoptable-reserved');
        if (filters.hasActiveReserve === 'yes' && !isReserved) {
          shouldShow = false;
        }
        if (filters.hasActiveReserve === 'no' && isReserved) {
          shouldShow = false;
        }
        
        // Show/hide animal
        animal.style.display = shouldShow ? 'block' : 'none';
        if (shouldShow) visibleCount++;
      });
      
      // Update results count
      updateResultsCount(visibleCount);
    }
    
    // Update results counter
    function updateResultsCount(count) {
      let counter = document.getElementById('results-counter');
      if (!counter) {
        counter = document.createElement('div');
        counter.id = 'results-counter';
        counter.className = 'text-sm text-gray-600 mb-4';
        const container = document.querySelector('.animals-grid')?.parentElement;
        if (container) {
          container.insertBefore(counter, container.querySelector('.animals-grid'));
        }
      }
      
      const total = document.querySelectorAll('.asm3-adoptable-item').length;
      counter.textContent = `Showing ${count} of ${total} animals`;
    }
    
    // Advanced view toggle
    function toggleAdvancedView() {
      const advancedSection = document.querySelector('#animal-filters > div:nth-child(2)');
      const toggleButton = document.getElementById('toggle-advanced');
      const toggleText = document.getElementById('advanced-toggle-text');
      
      if (!advancedSection || !toggleButton || !toggleText) return;
      
      const isHidden = advancedSection.style.display === 'none';
      
      if (isHidden) {
        advancedSection.style.display = 'block';
        toggleText.textContent = 'Simple View';
      } else {
        advancedSection.style.display = 'none';
        toggleText.textContent = 'Advanced View';
      }
      
      // Store preference
      localStorage.setItem('animal-filters-advanced', isHidden ? 'true' : 'false');
    }

    // Load saved view preference
    function loadViewPreference() {
      const preference = localStorage.getItem('animal-filters-advanced');
      if (preference === 'false') {
        toggleAdvancedView();
      }
    }

    // Event listeners
    form.addEventListener('change', handleFilterChange);
    clearButton.addEventListener('click', clearFilters);
    
    const toggleButton = document.getElementById('toggle-advanced');
    if (toggleButton) {
      toggleButton.addEventListener('click', toggleAdvancedView);
    }
    
    // Initialize view preference
    loadViewPreference();
    
    // Initialize filters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const initialFilters = Object.fromEntries(urlParams);
    
    // Set form values from URL
    Object.entries(initialFilters).forEach(([key, value]) => {
      const input = form.querySelector(`[name="${key}"]`);
      if (input) input.value = value;
    });
    
    // Apply initial filters
    filterAnimals(initialFilters);
  });
</script>

<style>
  .filter-select {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1rem;
    appearance: none;
  }
  
  .filter-select:focus {
    @apply border-transparent;
    outline: 2px solid rgb(168 85 247);
    outline-offset: 2px;
  }
</style>