---
import Base from "../../../layouts/Base.astro";
import CTASection from "../../../components/CTASection.astro";
const account = import.meta.env.PUBLIC_ASM_ACCOUNT || 'st3418';
const base = import.meta.env.PUBLIC_ASM_BASE || 'https://service.sheltermanager.com/asmservice';
const TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '';
export const prerender = false;

// Default form ID for surrender (can be overridden by URL param)
const url = new URL(Astro.request.url);
const formid = url.searchParams.get('formid') || '66';
---

<Base title="Surrendering a Pet | Homeless Hounds">
  <!-- Hero Section -->
  <section class="relative isolate overflow-hidden bg-white min-h-[50vh] flex items-center">
    <div class="absolute inset-0 -z-10">
      <div class="absolute inset-0 bg-gradient-to-br from-indigo-700 via-blue-600 to-indigo-800"></div>
    </div>
    <div class="absolute inset-0 bg-pattern-dots opacity-10"></div>

    <div class="container-custom py-20 md:py-24 relative z-10">
      <div class="max-w-4xl mx-auto text-center">
        <p class="text-white/80 text-sm uppercase tracking-widest font-semibold mb-4">We're here to help</p>
        <h1 class="text-white mb-6 text-4xl md:text-6xl font-bold">
          Surrendering a <span class="text-orange-400">Pet</span>
        </h1>
        <p class="text-xl md:text-2xl text-white/90 mb-10 max-w-3xl mx-auto">
          Homeless Hounds may be able to help you rehome your pet dog or cat. We understand surrendering a pet is never easy, and will endeavour to make the process as easy as possible for you and your animal.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="#surrender-form" class="btn btn-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Complete Form
          </a>
          <a href="/contact-us" class="inline-flex items-center justify-center px-6 py-3 border-2 border-white text-white font-semibold rounded-lg hover:bg-white hover:text-indigo-700 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-indigo-700">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Ask Questions
          </a>
        </div>
      </div>
    </div>
  </section>

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12" id="surrender-form">

    <!-- Important Information -->
    <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-6 mb-8">
      <div class="flex items-start space-x-3">
        <svg class="h-6 w-6 text-amber-600 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
        </svg>
        <div class="flex-1">
          <h3 class="text-lg font-bold text-amber-900 mb-2">Important Information</h3>
          <ul class="space-y-2 text-gray-700">
            <li class="flex items-start">
              <span class="text-amber-600 mr-2">â€¢</span>
              <span>Surrendering a pet dog or cat is usually only available to <strong>Victorian residents</strong></span>
            </li>
            <li class="flex items-start">
              <span class="text-amber-600 mr-2">â€¢</span>
              <span>If you are located interstate and able to transport your pet, we may be able to help</span>
            </li>
            <li class="flex items-start">
              <span class="text-amber-600 mr-2">â€¢</span>
              <span>The application form will take <strong>5-10 minutes</strong> to complete</span>
            </li>
            <li class="flex items-start">
              <span class="text-amber-600 mr-2">â€¢</span>
              <span>To ensure the best possible outcome for your pet, please complete the form thoroughly</span>
            </li>
          </ul>
        </div>
      </div>
    </div>

    {account && formid ? (
      <>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:p-8">
          <form id="asm-form" class="space-y-6" action="/api/submit" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="formid" value={formid} />

            <!-- Form Header from ASM (Description) -->
            <div id="form-header" class="hidden col-span-full bg-blue-50 border border-blue-200 rounded-xl p-6">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                <div class="text-sm text-gray-700" id="form-header-content"></div>
              </div>
            </div>

            <!-- Auto-save Notice -->
            <div class="bg-green-50 border border-green-200 rounded-lg px-4 py-3 mb-6">
              <div class="flex items-center">
                <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-sm text-green-800 font-medium">Your progress is automatically saved as you type.</span>
              </div>
            </div>

            <!-- Dynamic form fields will be inserted here -->
            <div id="asm-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Loading skeleton -->
              <div class="col-span-full animate-pulse">
                <div class="h-10 bg-gray-200 rounded mb-4"></div>
                <div class="h-10 bg-gray-200 rounded mb-4"></div>
                <div class="h-32 bg-gray-200 rounded mb-4"></div>
                <div class="h-10 bg-gray-200 rounded w-32"></div>
              </div>
            </div>

            <!-- Form Footer from ASM (Terms & Conditions) -->
            <div id="form-footer" class="hidden col-span-full bg-red-50 border border-red-200 rounded-xl p-6">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9C9 5 9 5.672 9 6.5S9 8 10 8s1-.672 1-1.5S11 5 10 5z" clip-rule="evenodd"></path>
                </svg>
                <div class="text-sm text-gray-700 font-medium" id="form-footer-content"></div>
              </div>
            </div>

            <!-- Turnstile widget -->
            {TURNSTILE_SITE_KEY && TURNSTILE_SITE_KEY !== '' && (
              <div class="pt-4 border-t border-gray-200">
                <div class="cf-turnstile" data-sitekey={TURNSTILE_SITE_KEY}></div>
              </div>
            )}

            <!-- Submit button -->
            <div class="pt-6">
              <button 
                type="submit" 
                id="submit-btn"
                disabled
                class="px-8 py-3 rounded-xl bg-gradient-to-r from-indigo-700 to-pink-600 text-white font-semibold hover:from-indigo-800 hover:to-pink-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Submit Surrender Request
              </button>
            </div>
          </form>
        </div>

        <!-- Field template for JavaScript -->
        <template id="field-tpl">
          <div class="flex flex-col gap-2">
            <label class="text-sm font-medium text-gray-700"></label>
            <div class="field-container w-full"></div>
            <p class="text-xs text-gray-500"></p>
            <p class="error-message text-xs text-red-600 hidden"></p>
          </div>
        </template>

        <!-- Load Turnstile -->
        {TURNSTILE_SITE_KEY && TURNSTILE_SITE_KEY !== '' && (
          <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
        )}
        
        <!-- Form builder script -->
        <script type="module" define:vars={{ account, formid }}>
          const container = document.getElementById("asm-fields");
          const tpl = document.getElementById("field-tpl");
          const submitBtn = document.getElementById("submit-btn");

          // Field type mappings
          const typeMap = {
            TEXT: () => createInput("text"),
            EMAIL: () => createInput("email"),
            NUMBER: () => createInput("number"),
            TELEPHONE: () => createInput("tel"),
            TEXTAREA: () => createTextarea(),
            NOTES: () => createTextarea(),
            LOOKUP: (f) => createSelect(f, false),
            LOOKUP_MULTI: (f) => createSelect(f, true),
            "MULTI-LOOKUP": (f) => createSelect(f, true),
            RADIO: (f) => createRadios(f),
            RADIOGROUP: (f) => createRadioGroup(f),
            CHECKBOX: (f) => createCheckbox(f),
            YESNO: (f) => createYesNoSelect(f),
            DATE: () => createInput("date"),
            FILE: () => createFileInput(),
            GDPR: (f) => createGDPR(f),
            GDPR_CONTACT_OPTIN: (f) => createGDPROptIn(f),
            HTMLNOTE: (f) => createHTMLNote(f),
            SPECIES: () => createInput("text"),
            BREED: () => createInput("text"),
            ADOPTABLEANIMAL: (f) => createAdoptableAnimal(f),
            SIGNATURE: (f) => createSignature(f)
          };

          function createInput(type) {
            const el = document.createElement("input");
            el.type = type;
            el.className = "w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-600 focus:ring-2 focus:ring-purple-200 transition-colors";
            return el;
          }

          function createTextarea() {
            const el = document.createElement("textarea");
            el.className = "w-full rounded-lg border border-gray-300 px-4 py-2 h-32 focus:border-indigo-600 focus:ring-2 focus:ring-purple-200 transition-colors";
            return el;
          }

          function createFileInput() {
            const el = document.createElement("input");
            el.type = "file";
            el.className = "w-full file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-800 hover:file:bg-indigo-200";
            el.accept = "image/*,.pdf,.doc,.docx";
            return el;
          }

          function createSelect(f, multiple) {
            const el = document.createElement("select");
            el.className = "w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-600 focus:ring-2 focus:ring-purple-200 transition-colors";
            if (multiple) el.multiple = true;
            
            // Add default option
            if (!multiple && !f.mandatory) {
              const defaultOpt = document.createElement("option");
              defaultOpt.value = "";
              defaultOpt.textContent = "-- Please select --";
              el.appendChild(defaultOpt);
            }
            
            // Add options from lookups
            (f.lookups || "").split("|").filter(Boolean).forEach(v => {
              const opt = document.createElement("option");
              opt.value = v;
              opt.textContent = v;
              el.appendChild(opt);
            });
            return el;
          }

          function createRadios(f) {
            const wrap = document.createElement("div");
            wrap.className = "flex flex-wrap gap-4";
            (f.lookups || "").split("|").filter(Boolean).forEach(v => {
              const lbl = document.createElement("label");
              lbl.className = "inline-flex items-center gap-2 cursor-pointer";
              const inp = document.createElement("input");
              inp.type = "radio";
              inp.name = f.name;
              inp.value = v;
              inp.className = "text-indigo-700 focus:ring-indigo-600";
              lbl.appendChild(inp);
              lbl.appendChild(document.createTextNode(v));
              wrap.appendChild(lbl);
            });
            return wrap;
          }

          function createYesNoSelect(f) {
            const el = document.createElement("select");
            el.className = "w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-600 focus:ring-2 focus:ring-purple-200 transition-colors";
            
            // Add default option
            if (!f.mandatory) {
              const defaultOpt = document.createElement("option");
              defaultOpt.value = "";
              defaultOpt.textContent = "-- Please select --";
              el.appendChild(defaultOpt);
            }
            
            // Add Yes/No options
            ["No", "Yes"].forEach(v => {
              const opt = document.createElement("option");
              opt.value = v;
              opt.textContent = v;
              el.appendChild(opt);
            });
            return el;
          }

          function createHTMLNote(f) {
            const div = document.createElement("div");
            div.className = "col-span-full bg-gray-50 rounded-lg p-4";
            div.innerHTML = f.label || f.tooltip || "";
            return div;
          }

          function createCheckbox(f) {
            const lbl = document.createElement("label");
            lbl.className = "inline-flex items-center gap-2 cursor-pointer";
            const inp = document.createElement("input");
            inp.type = "checkbox";
            inp.className = "rounded text-indigo-700 focus:ring-indigo-600";
            lbl.appendChild(inp);
            lbl.appendChild(document.createTextNode(f.label || "Yes"));
            inp.addEventListener("change", () => {
              inp.value = inp.checked ? "on" : "";
            });
            return lbl;
          }

          function createGDPR(f) {
            const wrap = document.createElement("div");
            wrap.className = "bg-gray-50 rounded-lg p-4";
            
            const lbl = document.createElement("label");
            lbl.className = "flex items-start gap-3 cursor-pointer";
            
            const inp = document.createElement("input");
            inp.type = "checkbox";
            inp.name = f.name;
            inp.className = "mt-1 rounded text-indigo-700 focus:ring-indigo-600";
            inp.required = true;
            
            const text = document.createElement("span");
            text.className = "text-sm text-gray-700";
            text.innerHTML = f.label || "I consent to the processing of my data";
            
            lbl.appendChild(inp);
            lbl.appendChild(text);
            wrap.appendChild(lbl);
            
            return wrap;
          }

          function createRadioGroup(f) {
            const wrap = document.createElement("div");
            wrap.className = "flex flex-col gap-2";
            (f.lookups || "").split("|").filter(Boolean).forEach((v, idx) => {
              const lbl = document.createElement("label");
              lbl.className = "flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer";
              const inp = document.createElement("input");
              inp.type = "radio";
              inp.name = f.name;
              inp.value = v;
              inp.className = "text-indigo-700 focus:ring-indigo-600";
              if (idx === 0 && f.mandatory) inp.required = true;
              const span = document.createElement("span");
              span.textContent = v;
              lbl.appendChild(inp);
              lbl.appendChild(span);
              wrap.appendChild(lbl);
            });
            return wrap;
          }

          function createAdoptableAnimal(f) {
            const el = document.createElement("input");
            el.type = "text";
            el.className = "w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-600 focus:ring-2 focus:ring-purple-200 transition-colors";
            el.placeholder = "Enter animal name or ID";
            return el;
          }

          function createSignature(f) {
            const wrap = document.createElement("div");
            wrap.className = "bg-gray-50 rounded-lg p-4";

            const canvas = document.createElement("canvas");
            canvas.width = 400;
            canvas.height = 150;
            canvas.className = "border border-gray-300 rounded-lg bg-white w-full";
            canvas.style.touchAction = "none";

            const input = document.createElement("input");
            input.type = "hidden";
            input.name = f.name;

            const clearBtn = document.createElement("button");
            clearBtn.type = "button";
            clearBtn.className = "mt-2 px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors";
            clearBtn.textContent = "Clear Signature";

            let isDrawing = false;
            const ctx = canvas.getContext("2d");
            ctx.strokeStyle = "#1e40af";
            ctx.lineWidth = 2;
            ctx.lineCap = "round";

            function getCoords(e) {
              const rect = canvas.getBoundingClientRect();
              const clientX = e.touches ? e.touches[0].clientX : e.clientX;
              const clientY = e.touches ? e.touches[0].clientY : e.clientY;
              return {
                x: clientX - rect.left,
                y: clientY - rect.top
              };
            }

            function startDrawing(e) {
              isDrawing = true;
              const coords = getCoords(e);
              ctx.beginPath();
              ctx.moveTo(coords.x, coords.y);
              e.preventDefault();
            }

            function draw(e) {
              if (!isDrawing) return;
              const coords = getCoords(e);
              ctx.lineTo(coords.x, coords.y);
              ctx.stroke();
              input.value = canvas.toDataURL();
              e.preventDefault();
            }

            function stopDrawing(e) {
              isDrawing = false;
              e.preventDefault();
            }

            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mousemove", draw);
            canvas.addEventListener("mouseup", stopDrawing);
            canvas.addEventListener("mouseout", stopDrawing);

            canvas.addEventListener("touchstart", startDrawing);
            canvas.addEventListener("touchmove", draw);
            canvas.addEventListener("touchend", stopDrawing);

            clearBtn.addEventListener("click", () => {
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              input.value = "";
            });

            wrap.appendChild(canvas);
            wrap.appendChild(clearBtn);
            wrap.appendChild(input);

            return wrap;
          }

          function createGDPROptIn(f) {
            const wrap = document.createElement("div");
            wrap.className = "bg-blue-50 rounded-lg p-4";

            const lbl = document.createElement("label");
            lbl.className = "flex items-start gap-3 cursor-pointer";

            const inp = document.createElement("input");
            inp.type = "checkbox";
            inp.name = f.name;
            inp.className = "mt-1 rounded text-indigo-700 focus:ring-indigo-600";
            inp.required = f.mandatory || false;

            const text = document.createElement("span");
            text.className = "text-sm text-gray-700";
            text.innerHTML = f.label || "I agree to receive updates (opt out anytime)";

            lbl.appendChild(inp);
            lbl.appendChild(text);
            wrap.appendChild(lbl);

            return wrap;
          }

          function renderField(f) {
            // Skip if no type or not a form field
            if (!f.type || !typeMap[f.type]) return null;
            
            const node = tpl.content.cloneNode(true);
            const label = node.querySelector("label");
            const holder = node.querySelector(".field-container");
            const help = node.querySelector("p");
            
            // Set label
            label.textContent = f.label || f.name;
            if (f.mandatory) {
              const req = document.createElement("span");
              req.className = "text-red-500 ml-1";
              req.textContent = "*";
              label.appendChild(req);
            }
            
            // Create control
            const control = typeMap[f.type](f);
            
            // Set name and required
            if (f.type !== "RADIO" && control.name !== f.name) {
              control.name = f.name;
            }
            if (f.mandatory && (control.tagName === "INPUT" || control.tagName === "SELECT" || control.tagName === "TEXTAREA")) {
              control.required = true;
              control.setAttribute("aria-required", "true");
            }
            
            // Add to container
            holder.appendChild(control);
            
            // Set help text
            if (f.tooltip) {
              help.textContent = f.tooltip;
              const helpId = `help-${f.name}`;
              help.id = helpId;
              if (control.setAttribute) {
                control.setAttribute("aria-describedby", helpId);
              }
            } else {
              help.remove();
            }
            
            return node;
          }

          async function fetchWithRetry(url, maxRetries = 3) {
            let lastError;
            
            for (let i = 0; i < maxRetries; i++) {
              try {
                const response = await fetch(url);
                if (response.ok) return response;
                lastError = new Error(`HTTP ${response.status}`);
              } catch (error) {
                lastError = error;
              }
              
              // Exponential backoff
              if (i < maxRetries - 1) {
                await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
              }
            }
            
            throw lastError;
          }

          async function init() {
            try {
              const schemaUrl = `/api/asm/form-schema?formid=${encodeURIComponent(formid)}`;
              const response = await fetchWithRetry(schemaUrl);
              const data = await response.json();

              // Display form header if available
              const headerEl = document.getElementById('form-header');
              const headerContent = document.getElementById('form-header-content');
              // Use 'header' field first, fallback to 'description' for backward compatibility
              const headerText = data.header || data.description;
              if (headerText && headerText.trim()) {
                // Convert plain text to HTML with line breaks
                headerContent.innerHTML = headerText.replace(/\n/g, '<br>').replace(/- /g, 'â€¢ ');
                headerEl.classList.remove('hidden');
              }

              // Display form footer if available
              const footerEl = document.getElementById('form-footer');
              const footerContent = document.getElementById('form-footer-content');
              if (data.footer && data.footer.trim()) {
                footerContent.innerHTML = data.footer;
                footerEl.classList.remove('hidden');
              }

              // Clear loading skeleton
              container.innerHTML = "";

              // Group fields into sections for better UX
              const sections = {
                'personal': {
                  title: 'ðŸ‘¤ Your Details',
                  fields: [],
                  indices: [1, 2, 3, 4, 5, 6, 7, 8, 9] // Personal info
                },
                'pet': {
                  title: 'ðŸ¾ Pet Details',
                  fields: [],
                  indices: [10, 11, 12, 13, 14, 15, 16, 17] // Pet info
                },
                'general': {
                  title: 'â“ General Questions',
                  fields: [],
                  indices: [18, 19, 20, 21, 22, 23, 24] // Microchip and surrender reason
                },
                'behavior': {
                  title: 'ðŸ¦´ Pet Behavior & Temperament',
                  fields: [],
                  indices: [25, 26, 27, 28, 29, 30, 31, 32, 33] // Behavior questions
                },
                'history': {
                  title: 'ðŸ“‹ Medical & Behavioral History',
                  fields: [],
                  indices: [34, 35, 36, 37, 38] // History questions
                },
                'agreement': {
                  title: 'âœï¸ Agreement & Signature',
                  fields: [],
                  indices: [39, 40] // Signature and date
                }
              };

              // Categorize fields into sections
              const fields = data.fields || [];
              fields.forEach(f => {
                // Skip section header fields (they're just text labels)
                if (f.type === 'TEXT' && (
                  f.label === 'Your Details' ||
                  f.label === 'Pet Details' ||
                  f.label === 'General Questions'
                )) {
                  return;
                }

                // Find which section this field belongs to
                let placed = false;
                for (const [key, section] of Object.entries(sections)) {
                  if (section.indices.includes(f.index)) {
                    section.fields.push(f);
                    placed = true;
                    break;
                  }
                }

                // If not placed, add to most appropriate section based on index
                if (!placed) {
                  if (f.index <= 9) sections.personal.fields.push(f);
                  else if (f.index <= 17) sections.pet.fields.push(f);
                  else if (f.index <= 24) sections.general.fields.push(f);
                  else if (f.index <= 33) sections.behavior.fields.push(f);
                  else if (f.index <= 38) sections.history.fields.push(f);
                  else sections.agreement.fields.push(f);
                }
              });

              // Render sections with fields
              Object.entries(sections).forEach(([key, section]) => {
                if (section.fields.length === 0) return;

                // Create section container
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'col-span-full';

                // Add section header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'mb-6 pb-3 border-b-2 border-gray-200';
                headerDiv.innerHTML = `
                  <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                    ${section.title}
                  </h3>
                `;
                sectionDiv.appendChild(headerDiv);

                // Create fields container
                const fieldsContainer = document.createElement('div');
                fieldsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';

                // Add fields to section
                section.fields.forEach(f => {
                  const field = renderField(f);
                  if (field) {
                    // Make some fields full-width
                    if (f.type === 'NOTES' || f.type === 'TEXTAREA' || f.type === 'SIGNATURE' ||
                        f.type === 'GDPR' || f.type === 'HTMLNOTE' || f.type === 'RADIOGROUP' ||
                        f.label.includes('If you have any further') || f.label.includes('Does your')) {
                      field.querySelector('div').classList.add('col-span-full');
                    }
                    fieldsContainer.appendChild(field);
                  }
                });

                sectionDiv.appendChild(fieldsContainer);
                container.appendChild(sectionDiv);

                // Add spacing between sections
                if (key !== 'agreement') {
                  const spacer = document.createElement('div');
                  spacer.className = 'col-span-full h-6';
                  container.appendChild(spacer);
                }
              });

              // Enable submit button
              submitBtn.disabled = false;
              
            } catch (error) {
              console.error('Failed to load form:', error);
              container.innerHTML = `
                <div class="col-span-full">
                  <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                    <div class="text-red-600 mb-4">
                      <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <p class="text-red-800 font-medium mb-2">Unable to load form</p>
                    <p class="text-sm text-red-600 mb-4">Please try again or contact us directly.</p>
                    <a href="https://service.sheltermanager.com/asmservice?account=${account}&method=online_form_html&formid=${formid}" 
                       class="inline-block px-6 py-2 bg-red-100 hover:bg-red-200 text-red-800 rounded-lg font-medium transition-colors"
                       target="_blank">
                      Open Form in New Window
                    </a>
                  </div>
                </div>
              `;
            }
          }

          // Initialize when DOM is ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
          } else {
            init();
          }
        </script>
      </>
    ) : (
      <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
        <p class="text-red-800 font-medium mb-2">Form Configuration Missing</p>
        <p class="text-sm text-red-600">Please set PUBLIC_ASM_ACCOUNT in environment variables.</p>
      </div>
    )}

    <div class="mt-8 text-center">
      <p class="text-sm text-gray-500">
        Having trouble? <a href="/contact-us" class="text-indigo-700 hover:text-indigo-800 underline">Contact us directly</a>
      </p>
    </div>
  </div>

  <!-- CTA Section -->
  <CTASection />
</Base>