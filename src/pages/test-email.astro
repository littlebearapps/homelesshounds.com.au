---
import Base from '../layouts/Base.astro';

// Only show in development
if (import.meta.env.MODE !== 'development') {
  return Astro.redirect('/404');
}

export const prerender = false;
---

<Base title="Email Test Page | Homeless Hounds">
  <main class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
      <div class="bg-white shadow-xl rounded-lg p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Email System Test</h1>

        <div class="space-y-8">
          <!-- Test Email -->
          <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">1. Test Email Configuration</h2>
            <p class="text-gray-600 mb-4">Send a test email to verify SendGrid configuration is working.</p>

            <form id="testEmailForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Test Email Address
                </label>
                <input
                  type="email"
                  name="email"
                  value="web@homelesshounds.com.au"
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                />
              </div>
              <button
                type="submit"
                class="px-6 py-2 bg-indigo-700 text-white rounded-lg hover:bg-indigo-800 transition-colors"
              >
                Send Test Email
              </button>
            </form>
            <div id="testResult" class="mt-4"></div>
          </section>

          <!-- Test Surrender Email -->
          <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">2. Test Surrender Notification</h2>
            <p class="text-gray-600 mb-4">Simulate a surrender form submission to test email templates.</p>

            <form id="surrenderTestForm" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    First Name
                  </label>
                  <input
                    type="text"
                    name="firstname"
                    value="Test"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Last Name
                  </label>
                  <input
                    type="text"
                    name="lastname"
                    value="User"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                  />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Email
                </label>
                <input
                  type="email"
                  name="email"
                  value="web@homelesshounds.com.au"
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Pet Name
                  </label>
                  <input
                    type="text"
                    name="animalname"
                    value="Buddy"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Species
                  </label>
                  <select
                    name="species"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                  >
                    <option value="Dog">Dog</option>
                    <option value="Cat">Cat</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Breed
                  </label>
                  <input
                    type="text"
                    name="breed"
                    value="Labrador"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                  />
                </div>
              </div>

              <button
                type="submit"
                class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors"
              >
                Send Surrender Test Emails
              </button>
            </form>
            <div id="surrenderResult" class="mt-4"></div>
          </section>

          <!-- Test Adoption Email -->
          <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">3. Test Adoption Notification</h2>
            <p class="text-gray-600 mb-4">Simulate an adoption application to test email templates.</p>

            <form id="adoptionTestForm" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    First Name
                  </label>
                  <input
                    type="text"
                    name="firstname"
                    value="Jane"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Last Name
                  </label>
                  <input
                    type="text"
                    name="lastname"
                    value="Adopter"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                  />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Email
                </label>
                <input
                  type="email"
                  name="email"
                  value="web@homelesshounds.com.au"
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Pet Name
                  </label>
                  <input
                    type="text"
                    name="pet_name"
                    value="Spike"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Pet Species
                  </label>
                  <select
                    name="pet_species"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                  >
                    <option value="Dog">Dog</option>
                    <option value="Cat">Cat</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Pet Breed
                  </label>
                  <input
                    type="text"
                    name="pet_breed"
                    value="Mixed Breed"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"
                  />
                </div>
              </div>

              <button
                type="submit"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                Send Adoption Test Emails
              </button>
            </form>
            <div id="adoptionResult" class="mt-4"></div>
          </section>
        </div>

        <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p class="text-sm text-yellow-800">
            <strong>Note:</strong> This page is only available in development mode.
            Check the browser console for detailed email sending logs.
          </p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Test basic email
    document.getElementById('testEmailForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const resultDiv = document.getElementById('testResult')!;

      resultDiv.innerHTML = '<p class="text-blue-600">Sending test email...</p>';

      try {
        const response = await fetch('/api/test-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: form.email.value
          })
        });

        const result = await response.json();

        if (result.success) {
          resultDiv.innerHTML = '<p class="text-green-600">✅ Test email sent successfully!</p>';
        } else {
          resultDiv.innerHTML = `<p class="text-red-600">❌ Failed: ${result.error}</p>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="text-red-600">❌ Error: ${error}</p>`;
      }
    });

    // Test surrender emails
    document.getElementById('surrenderTestForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const resultDiv = document.getElementById('surrenderResult')!;

      resultDiv.innerHTML = '<p class="text-blue-600">Sending surrender test emails...</p>';

      try {
        const response = await fetch('/api/test-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'surrender',
            formId: '37',
            data: Object.fromEntries(formData)
          })
        });

        const result = await response.json();

        if (result.success) {
          resultDiv.innerHTML = `
            <p class="text-green-600">✅ Emails sent!</p>
            <ul class="text-sm text-gray-600 mt-2">
              <li>Admin: ${result.admin ? 'Sent' : 'Failed'}</li>
              <li>User: ${result.user ? 'Sent' : 'Failed'}</li>
            </ul>
          `;
        } else {
          resultDiv.innerHTML = `<p class="text-red-600">❌ Failed: ${result.error}</p>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="text-red-600">❌ Error: ${error}</p>`;
      }
    });

    // Test adoption emails
    document.getElementById('adoptionTestForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const resultDiv = document.getElementById('adoptionResult')!;

      resultDiv.innerHTML = '<p class="text-blue-600">Sending adoption test emails...</p>';

      try {
        const response = await fetch('/api/test-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'adoption',
            formId: '39',
            data: Object.fromEntries(formData)
          })
        });

        const result = await response.json();

        if (result.success) {
          resultDiv.innerHTML = `
            <p class="text-green-600">✅ Emails sent!</p>
            <ul class="text-sm text-gray-600 mt-2">
              <li>Admin: ${result.admin ? 'Sent' : 'Failed'}</li>
              <li>User: ${result.user ? 'Sent' : 'Failed'}</li>
            </ul>
          `;
        } else {
          resultDiv.innerHTML = `<p class="text-red-600">❌ Failed: ${result.error}</p>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="text-red-600">❌ Error: ${error}</p>`;
      }
    });
  </script>
</Base>